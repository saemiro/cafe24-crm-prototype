{
  "name": "Cafe24_CRM_Insight_Publisher",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "30 12,18 * * *"
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "Digest 12:30PM & 6:30PM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://qdrant:6333/collections/cafe24_insights/points/scroll",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ limit: 50, with_payload: true, with_vector: false }) }}"
      },
      "id": "get-all-insights",
      "name": "Get All Insights",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [450, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://neo4j:7474/db/neo4j/tx/commit",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Basic bmVvNGo6b250b2xvZ3kyMDI1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ statements: [{ statement: 'MATCH (n) WHERE n:CRM_Entity OR n:CRM_Pattern OR n:CRM_Workflow RETURN labels(n)[0] as type, count(n) as count, collect(n.name)[0..3] as samples' }, { statement: 'MATCH (f:CRM_Feedback) WHERE f.timestamp > datetime() - duration({hours: 24}) RETURN f.action as action, count(*) as count, avg(toFloat(f.score_delta)) as avg_delta ORDER BY count DESC LIMIT 5' }] }) }}"
      },
      "id": "get-ontology-summary",
      "name": "Get Ontology Summary",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [450, 400]
    },
    {
      "parameters": {
        "jsCode": "const insights = $('Get All Insights').first().json.result?.points || [];\nconst ontologyResults = $('Get Ontology Summary').first().json.results || [];\n\n// Group insights by type with recent first\nconst insightsByType = {};\ninsights.forEach(p => {\n  const type = p.payload?.type || 'unknown';\n  if (!insightsByType[type]) insightsByType[type] = [];\n  insightsByType[type].push({\n    timestamp: p.payload?.timestamp,\n    content: p.payload?.analysis || p.payload?.summary || p.payload?.content || 'No content'\n  });\n});\n\n// Get ontology stats\nconst ontologyStats = {};\nif (ontologyResults[0]?.data) {\n  ontologyResults[0].data.forEach(d => {\n    ontologyStats[d.row[0]] = {\n      count: d.row[1],\n      samples: d.row[2]\n    };\n  });\n}\n\n// Get feedback summary\nconst feedbackSummary = [];\nif (ontologyResults[1]?.data) {\n  ontologyResults[1].data.forEach(d => {\n    feedbackSummary.push({\n      action: d.row[0],\n      count: d.row[1],\n      avg_delta: d.row[2]\n    });\n  });\n}\n\n// Select top insights for publication\nconst topInsights = [];\nObject.entries(insightsByType).forEach(([type, items]) => {\n  if (items.length > 0) {\n    topInsights.push({\n      type: type,\n      latest: items[0]?.content?.substring(0, 200) || 'N/A',\n      count: items.length\n    });\n  }\n});\n\nreturn {\n  date: new Date().toISOString().split('T')[0],\n  total_insights: insights.length,\n  insight_types: Object.keys(insightsByType).length,\n  ontology_stats: ontologyStats,\n  feedback_summary: feedbackSummary,\n  top_insights: topInsights.slice(0, 5),\n  publication_context: JSON.stringify({ types: Object.keys(insightsByType), stats: ontologyStats })\n};"
      },
      "id": "compile-daily-digest",
      "name": "Compile Daily Digest",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://claude-wrapper:4001/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer sk-litellm-master-key"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'sonnet', messages: [{ role: 'system', content: 'ë‹¹ì‹ ì€ CRM ì¸ì‚¬ì´íŠ¸ ì—ë””í„°ìž…ë‹ˆë‹¤. ì¼ì¼ ì¸ì‚¬ì´íŠ¸ë¥¼ ì½ê¸° ì‰½ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ìš”ì•½ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ìž‘ì„±í•˜ì„¸ìš”. ì´ëª¨ì§€ë¥¼ ì ì ˆížˆ ì‚¬ìš©í•˜ì„¸ìš”.' }, { role: 'user', content: 'ì˜¤ëŠ˜ì˜ CRM ì¸ì‚¬ì´íŠ¸ ë‹¤ì´ì œìŠ¤íŠ¸ë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”. ì´ ì¸ì‚¬ì´íŠ¸: ' + $json.total_insights + 'ê°œ, íƒ€ìž… ìˆ˜: ' + $json.insight_types + '. ìƒìœ„ ì¸ì‚¬ì´íŠ¸: ' + JSON.stringify($json.top_insights) + '. í”¼ë“œë°± ìš”ì•½: ' + JSON.stringify($json.feedback_summary) + '. í•µì‹¬ í¬ì¸íŠ¸ 3ê°€ì§€ì™€ ë‚´ì¼ ì£¼ëª©í•  ì˜ì—­ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.' }], max_tokens: 1024 }) }}"
      },
      "id": "generate-digest",
      "name": "Generate Digest",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [950, 300]
    },
    {
      "parameters": {
        "jsCode": "const digest = $json.choices?.[0]?.message?.content || 'Digest generation failed';\nconst compiledData = $('Compile Daily Digest').first().json;\n\nreturn {\n  date: compiledData.date,\n  type: 'daily_digest',\n  total_insights: compiledData.total_insights,\n  insight_types: compiledData.insight_types,\n  ontology_node_count: Object.values(compiledData.ontology_stats).reduce((a, b) => a + (b.count || 0), 0),\n  feedback_actions: compiledData.feedback_summary.length,\n  digest_content: digest,\n  published_at: new Date().toISOString()\n};"
      },
      "id": "format-publication",
      "name": "Format Publication",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SLACK_WEBHOOK }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ blocks: [{ type: 'header', text: { type: 'plain_text', text: 'ðŸ“° Daily CRM Insight Digest - ' + $json.date, emoji: true } }, { type: 'section', text: { type: 'mrkdwn', text: '*ðŸ“Š ì˜¤ëŠ˜ì˜ ì§€í‘œ*\\nâ€¢ ì´ ì¸ì‚¬ì´íŠ¸: ' + $json.total_insights + 'ê°œ\\nâ€¢ ì¸ì‚¬ì´íŠ¸ íƒ€ìž…: ' + $json.insight_types + 'ì¢…\\nâ€¢ ì˜¨í†¨ë¡œì§€ ë…¸ë“œ: ' + $json.ontology_node_count + 'ê°œ\\nâ€¢ í”¼ë“œë°± ì•¡ì…˜: ' + $json.feedback_actions + 'ê±´' } }, { type: 'divider' }, { type: 'section', text: { type: 'mrkdwn', text: '*ðŸ“ ë‹¤ì´ì œìŠ¤íŠ¸*\\n' + $json.digest_content.substring(0, 1500) } }, { type: 'context', elements: [{ type: 'mrkdwn', text: 'ðŸ¤– Cafe24 CRM Prototype | Published at ' + $json.published_at }] }] }) }}"
      },
      "id": "publish-to-slack",
      "name": "Publish to Slack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "http://qdrant:6333/collections/cafe24_insights/points",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ points: [{ id: Math.floor(Math.random() * 1000000), vector: Array(1536).fill(0).map(() => Math.random() * 0.1), payload: { type: 'daily_digest', date: $json.date, total_insights: $json.total_insights, digest_summary: $json.digest_content.substring(0, 500), published_at: $json.published_at } }] }) }}"
      },
      "id": "archive-digest",
      "name": "Archive Digest",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 400]
    }
  ],
  "connections": {
    "Daily 6PM": {
      "main": [
        [
          {
            "node": "Get All Insights",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Ontology Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Insights": {
      "main": [
        [
          {
            "node": "Compile Daily Digest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Ontology Summary": {
      "main": [
        [
          {
            "node": "Compile Daily Digest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compile Daily Digest": {
      "main": [
        [
          {
            "node": "Generate Digest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Digest": {
      "main": [
        [
          {
            "node": "Format Publication",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Publication": {
      "main": [
        [
          {
            "node": "Publish to Slack",
            "type": "main",
            "index": 0
          },
          {
            "node": "Archive Digest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Cafe24_CRM_Prototype"
    },
    {
      "name": "Emergent_Intelligence"
    }
  ]
}
